version: '3.8'

services:
  # â˜• ìŠ¤í”„ë§ ë¶€íŠ¸ (ë°±ì—”ë“œ)
  backend:
    build: ./backend
    ports:
      - "8080:8080"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - FIREBASE_CONFIG_PATH=/app/firebase-key.json
      - MYBATIS_MAPPER_LOCATIONS=classpath:mapper/**/*.xml
    env_file:
      - .env  # EC2ì˜ .env ë‚´ìš©ì„ ê°€ì ¸ì˜´
    volumes:
      # EC2ì˜ firebase íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ /app í´ë”ë¡œ ì—°ê²°
      - ./firebase-service-account.json:/app/firebase-key.json
    depends_on:
      - ai-server
    restart: always

  # ğŸ AI ì„œë²„
  ai-server:
    build: ./ai_model
    ports:
      - "8000:8000"
    env_file:
      - .env  # ê°™ì€ .env ì‚¬ìš©
    restart: always


    # ğŸ–¥ï¸ í”„ë¡ íŠ¸ì—”ë“œ (Nginx)
  frontend:
    build:
      context: ./frontend
      args:
        # EC2ì˜ .envì— ìˆëŠ” ê°’ì„ Dockerfileë¡œ ì „ë‹¬
        VITE_API_URL: ${VITE_API_URL}
        VITE_KAKAO_CLIENT_ID: ${VITE_KAKAO_CLIENT_ID}
        VITE_KAKAO_REDIRECT_URI: ${VITE_KAKAO_REDIRECT_URI}
        VITE_FIREBASE_API_KEY: ${VITE_FIREBASE_API_KEY}
        VITE_FIREBASE_AUTH_DOMAIN: ${VITE_FIREBASE_AUTH_DOMAIN}
        VITE_FIREBASE_PROJECT_ID: ${VITE_FIREBASE_PROJECT_ID}
        VITE_FIREBASE_STORAGE_BUCKET: ${VITE_FIREBASE_STORAGE_BUCKET}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${VITE_FIREBASE_MESSAGING_SENDER_ID}
        VITE_FIREBASE_APP_ID: ${VITE_FIREBASE_APP_ID}
        VITE_FIREBASE_VAPID_KEY: ${VITE_FIREBASE_VAPID_KEY}
    ports:
      - "80:80"  # ì›¹ ë¸Œë¼ìš°ì € ê¸°ë³¸ í¬íŠ¸(80)ë¡œ ì ‘ì†
    restart: always
