<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒí‘œ AI í†µí•© ì§„ë‹¨ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
        body { font-family: 'Pretendard', sans-serif; background:#f4f7f9; padding:20px; color: #333; line-height: 1.6; }
        .container { max-width:1000px; margin:auto; background:#fff; padding:30px; border-radius:12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align:center; color: #007bff; margin-bottom: 30px; font-weight: 800; }
        
        form { display:flex; flex-wrap: wrap; gap:12px; margin-bottom:30px; background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e9ecef; align-items: center; }
        input[type="text"] { flex: 1; min-width: 250px; padding:12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        input[type="file"] { flex: 1; min-width: 200px; }
        .btn-search { background: #007bff; color: white; cursor: pointer; border: none; font-weight: bold; padding: 12px 30px; border-radius: 6px; font-size: 16px; transition: 0.3s; }
        .btn-search:hover { background: #0056b3; }
        
        #results { display: grid; gap: 15px; }
        .trademark-item { display:flex; align-items:center; border:1px solid #eee; padding:20px; border-radius:12px; background:#fff; transition: 0.3s; }
        .trademark-item:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-color: #007bff; }
        .trademark-item img { width:110px; height:110px; object-fit:contain; margin-right:25px; border-radius: 8px; background: #fff; border: 1px solid #f0f0f0; }
        .trademark-details { flex-grow: 1; }
        .trademark-details h3 { margin: 0 0 8px 0; font-size: 20px; color: #222; }
        .trademark-details p { margin: 4px 0; color: #666; font-size: 14px; }
        .similarity { margin-top:8px; font-weight:bold; color: #28a745; font-size: 1.1rem; }
        
        .btn-analyze { background: #28a745; color: white; cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; margin-top: 12px; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-analyze:hover { background: #218838; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; backdrop-filter: blur(4px); }
        #ai-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 750px; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); z-index: 1000; overflow-y: auto; max-height: 85vh; }
        
        .ai-summary-box { background: #f0f7ff; padding: 25px; border-radius: 15px; border-left: 10px solid #007bff; margin: 20px 0; }
        .section-title { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 15px; font-weight: bold; color: #222; font-size: 18px; display: flex; align-items: center; }
        .section-title::before { content: ''; display: inline-block; width: 4px; height: 18px; background: #007bff; margin-right: 10px; border-radius: 2px; }
        
        .report-card { background: #fdfdfd; border: 1px solid #f0f0f0; padding: 20px; border-radius: 12px; }
        .report-card p { margin-bottom: 10px; }
        ul { padding-left: 20px; margin: 10px 0; }
        li { margin-bottom: 8px; }
        
        .close-btn { width:100%; padding:15px; margin-top:30px; cursor:pointer; background: #333; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .close-btn:hover { background: #000; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ” ìƒí‘œ AI í†µí•© ì§„ë‹¨ ì„œë¹„ìŠ¤</h1>
	<form id="analysisForm">
	    <input type="text" id="keyword" placeholder="ìƒí‘œëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œí•˜ì„¸ìš”.">
	    
	    <input type="file" id="logo" accept="image/*">
	    
	    <button type="submit" class="btn-search">ìœ ì‚¬ ìƒí‘œ ê²€ìƒ‰</button>
	    
	    <button type="button" class="btn-analyze" style="margin-top:0; background:#6c757d;" onclick="saveMyBrand()">
	        ğŸ’¾ ë‚´ ë¸Œëœë“œ ì €ì¥
	    </button>
	</form>
    <div id="results">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<div id="modal-overlay" class="modal-overlay" onclick="closeModal()"></div>
<div id="ai-modal">
    <h2 id="modal-title" style="color:#007bff; margin-top:0; font-size: 24px;">ğŸ¤– AI ì •ë°€ ì§„ë‹¨ ê²°ê³¼</h2>
    <div id="ai-summary-area" class="ai-summary-box"></div>
    <div id="ai-report-content"></div>
    <button class="close-btn" onclick="closeModal()">ì§„ë‹¨ ì™„ë£Œ ë° ë‹«ê¸°</button>
</div>

<script>
const API_BASE_URL = "http://localhost:8080/api/analysis";
const TEST_USER_ID = 1; 
const TEST_BRAND_ID = 1; 
// ì‚¬ìš©ìê°€ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì´ ë³€ìˆ˜ì— íŒŒì¼ëª…ì„ ë‹´ì•„ ë°±ì—”ë“œë¡œ ë³´ëƒ…ë‹ˆë‹¤.
let currentLogoPath = "uploads/temp_logo.png"; 

/**
 * [ì¶”ê°€ ê¸°ëŠ¥] ë‚´ ë¸Œëœë“œ ê¸°ë³¸ ì €ì¥ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ)
 */
	 let currentPatentId = null; 
	 async function saveMyBrand() {
	     // 1. ì„ íƒëœ íŠ¹í—ˆ ID í™•ì¸
	     if (!currentPatentId) {
	         alert("ì €ì¥í•  íŠ¹í—ˆë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
	         return;
	     }

	     // 2. í™”ë©´ì—ì„œ ë°ì´í„° ì¶”ì¶œ
	     const brandName = document.getElementById('keyword').value || "ì‹ ê·œ ë¸Œëœë“œ";
	     const summaryElement = document.getElementById('ai-summary-area');
	     
	     // GPT ë¶„ì„ ê²°ê³¼ê°€ ìˆëŠ”ì§€ í™•ì¸ (ê³µë°± ì œê±° í›„ ê²€ì‚¬)
	     const summaryText = (summaryElement && summaryElement.innerText.trim()) 
	                         ? summaryElement.innerText.trim() 
	                         : "ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";

	     try {
	         const queryParams = new URLSearchParams({
	             logoPath: currentLogoPath,
	             brandId: Number(TEST_BRAND_ID),
	             patentId: currentPatentId,
	             aiSummary: summaryText,         // âœ… GPTì˜ ì‹¤ì œ ë¶„ì„ ë‚´ìš© ì „ì†¡
	             searchedBrandName: brandName    // âœ… ì…ë ¥í•œ ìƒí‘œëª… ì „ì†¡
	         });

	         const response = await fetch(`${API_BASE_URL}/save-basic?${queryParams.toString()}`, {
	             method: 'POST'
	         });

	         if (response.ok) {
	             alert("âœ… ë‚´ ë¸Œëœë“œì™€ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
	         } else {
	             const errorMsg = await response.text();
	             throw new Error(errorMsg);
	         }
	     } catch (error) {
	         console.error("Save Error:", error);
	         alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
	     }
	 }
// 1. ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ ë¡œì§
document.getElementById('analysisForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const keyword = document.getElementById('keyword').value;
    const logoFile = document.getElementById('logo').files[0];
    
    if (logoFile) {
        currentLogoPath = "uploads/" + logoFile.name;
    }

    const formData = new FormData();
    formData.append('keyword', keyword);
    if (logoFile) formData.append('logo', logoFile);

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '<p style="text-align:center; padding: 40px;">ğŸš€ ì‹¤ì‹œê°„ ìƒí‘œ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>';

	try {
	        const response = await fetch(`${API_BASE_URL}/run`, { method: 'POST', body: formData });
	        const data = await response.json();
	        resultsDiv.innerHTML = ''; 

	        if(!data || data.length === 0) {
	            currentPatentId = null;
	            resultsDiv.innerHTML = '<p style="text-align:center; padding: 40px;">ìœ ì‚¬í•œ ìƒí‘œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
	            return;
	        }
	
	        // âœ… [í•µì‹¬ ì¶”ê°€] ë°±ì—”ë“œ searchì—ì„œ GPTê°€ ë§Œë“  aiSummaryë¥¼ í™”ë©´ ìƒë‹¨ ìš”ì•½ì°½ì— í‘œì‹œ
	        const mainSummary = data[0].aiSummary || "ë¶„ì„ ìš”ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
			
			
			let summaryBox = document.getElementById('main-ai-summary');
			        if (!summaryBox) {
			            summaryBox = document.createElement('div');
			            summaryBox.id = 'main-ai-summary';
			            summaryBox.className = 'ai-summary-box'; // ê¸°ì¡´ CSS í™œìš©
			            document.querySelector('.container').insertBefore(summaryBox, resultsDiv);
			        }
			        summaryBox.innerText = "ğŸ¤– GPT ì „ì²´ ì§„ë‹¨: " + mainSummary;

			        // ë˜í•œ, ì €ì¥ ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ai-summary-area(ëª¨ë‹¬ìš©)ì—ë„ ë¯¸ë¦¬ ê°’ì„ ë„£ì–´ë‘¡ë‹ˆë‹¤.
			        document.getElementById('ai-summary-area').innerText = mainSummary;

			        currentPatentId = data[0].patentId || data[0].id;
        /* ===================================================
           âœ… [ì¶”ê°€] ê²€ìƒ‰ ê²°ê³¼ ì¤‘ ì²« ë²ˆì§¸ ìƒí‘œì˜ IDë¥¼ ë³€ìˆ˜ì— ì €ì¥
           ì„œë²„ ì‘ë‹µ í•„ë“œëª…ì— ë”°ë¼ patentId, id, applicationNumber ì¤‘ ë§ëŠ” ê²ƒì„ ì„ íƒí•˜ì„¸ìš”.
           =================================================== */
        currentPatentId = data[0].patentId || data[0].id || data[0].applicationNumber;
        console.log("ìë™ ì„ íƒëœ íŠ¹í—ˆ ID:", currentPatentId);

        data.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'trademark-item';
            
            // ë°ì´í„° í•„ë“œëª… ë§¤í•‘ (ë°±ì—”ë“œ ì‘ë‹µ êµ¬ì¡°ì— ë§ì¶¤)
            const displayName = item.trademark_name || item.trademarkName || item.name || "ì •ë³´ ì—†ìŒ";
            const displayImg = item.image_url || item.imageUrl || "https://via.placeholder.com/110?text=No+Image";
            const score = item.combinedSimilarity || item.combined_similarity || 0;

            itemDiv.innerHTML = `
                <img src="${displayImg}" onerror="this.src='https://via.placeholder.com/110?text=No+Image'" alt="ìƒí‘œ">
                <div class="trademark-details">
                    <h3>${displayName}</h3>
                    <p><strong>ì¶œì›ì¸:</strong> ${item.applicant || 'ì •ë³´ ì—†ìŒ'}</p>
                    <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${item.category || 'ê¸°íƒ€'}</p>
                    <div class="similarity">ìœ ì‚¬ë„: ${score.toFixed(2)}%</div>
                    <button class="btn-analyze" id="btn-ai-${index}" 
                            onclick='startIndividualAiAnalysis(${JSON.stringify(item)}, ${index})'>
                        ğŸ¤– 1:1 ì •ë°€ ë¶„ì„ ì‹¤í–‰
                    </button>
                </div>
            `;
            resultsDiv.appendChild(itemDiv);
        });
    } catch (error) {
        console.error("Fetch Error:", error);
        resultsDiv.innerHTML = '<p style="color:red; text-align:center; padding: 40px;">ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
});

// 2. ê°œë³„ AI ìƒì„¸ ë¶„ì„ ë¡œì§
async function startIndividualAiAnalysis(selectedItem, index) {
    const keyword = document.getElementById('keyword').value;
    const aiBtn = document.getElementById(`btn-ai-${index}`);
    
    aiBtn.innerText = "â³ AIê°€ ë¶„ì„ ì¤‘...";
    aiBtn.disabled = true;

    try {
        // ë°±ì—”ë“œ ì»¨íŠ¸ë¡¤ëŸ¬ íŒŒë¼ë¯¸í„° ìˆœì„œì— ë§ì¶¤ (keyword, userId, logoPath, brandId)
        const queryParams = new URLSearchParams({
            keyword: keyword, 
            userId: TEST_USER_ID, 
            logoPath: currentLogoPath, 
            brandId: TEST_BRAND_ID
        });

        const response = await fetch(`${API_BASE_URL}/analyze?${queryParams.toString()}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(selectedItem)
        });

        const resultData = await response.json();
        console.log("AI ë¶„ì„ ì‘ë‹µ:", resultData);

        /* =========================
           âœ… ì—¬ê¸°ë¶€í„° í•µì‹¬ ìˆ˜ì •
        ========================= */

        const risk = resultData.riskLevel || "ì£¼ì˜";
        const summary = resultData.aiAnalysisSummary || "AI ë¶„ì„ ìš”ì•½ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.";
        const report = resultData.aiDetailedReport || {};
        const solution = resultData.aiSolution || {};

        const name = selectedItem.trademark_name || selectedItem.name || "ë¶„ì„ ìƒí‘œ";
        document.getElementById('modal-title').innerText = `ğŸ¤– [${name}] AI ì •ë°€ ë¦¬í¬íŠ¸`;

        const riskColor =
            (risk === 'ìœ„í—˜' || risk.toLowerCase() === 'high')
                ? '#d9534f'
                : '#f0ad4e';

        document.getElementById('ai-summary-area').innerHTML = `
            <div style="font-size: 1.4rem; color: ${riskColor}; font-weight: 800; margin-bottom: 10px;">
                ìœ„í—˜ë„ ë“±ê¸‰: ${risk}
            </div>
            <div style="font-size: 16px; line-height:1.5;">
                ${summary}
            </div>
        `;

        /* =========================
           ìƒì„¸ ë¦¬í¬íŠ¸
        ========================= */

        let reportHtml = `
            <div class="section-title">ğŸ” AI ë³€ë¦¬ì‚¬ ìƒì„¸ ë¶„ì„</div>
            <div class="report-card">
                <p><strong>â€¢ ëª…ì¹­ ìœ ì‚¬ì„±:</strong> ${report.name_similarity || 'ë¶„ì„ ì¤‘'}</p>
                <p><strong>â€¢ ì—…ì¢… ì¤‘ë³µì„±:</strong> ${report.category_overlap || 'ë¶„ì„ ì¤‘'}</p>
                <p><strong>â€¢ ì‹œì¥ í˜¼ë™ ê°€ëŠ¥ì„±:</strong> ${report.market_confusion || 'ë¶„ì„ ì¤‘'}</p>
            </div>
        `;

        /* =========================
           ê¶Œì¥ ëŒ€ì‘ ì „ëµ
        ========================= */
		
		let solutionObj = solution;
		if (typeof solution === 'string') {
		    try {
		        solutionObj = JSON.parse(solution);
		    } catch (e) {
		        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì¼ë°˜ ë¬¸ìì—´ë¡œ ì·¨ê¸‰
		        solutionObj = { info: solution };
		    }
		}
		
		reportHtml += `
		    <div class="section-title">ğŸ’¡ ê¶Œì¥ ëŒ€ì‘ ì „ëµ</div>
		    <div class="report-card">
		`;
		
		if (typeof solution === 'string') {
		    // ë§Œì•½ ë¬¸ìì—´ì´ë¼ë©´ (í˜„ì¬ ìƒí™©), ë°˜ë³µë¬¸ ì—†ì´ í†µì§¸ë¡œ ì¶œë ¥
		    reportHtml += `
		        <div style="line-height: 1.6; white-space: pre-wrap; padding: 10px;">
		            ${solution}
		        </div>
		    `;
		} else if (typeof solution === 'object' && solution !== null) {
		    // ë§Œì•½ JSON ê°ì²´ë¼ë©´, ë‚´ë¶€ ê°’ì„ ìˆœíšŒí•˜ë©° ë¦¬ìŠ¤íŠ¸ë¡œ ì¶œë ¥
		    reportHtml += `<ul>`;
		    Object.values(solution).forEach(value => {
		        // valueê°€ ë‹¤ì‹œ ê°ì²´ë‚˜ ë°°ì—´ì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í•œ ë²ˆ ë” ì²´í¬
		        const text = typeof value === 'object' ? JSON.stringify(value) : value;
		        reportHtml += `<li style="margin-bottom:8px; list-style-type: disc; margin-left: 20px;">${text}</li>`;
		    });
		    reportHtml += `</ul>`;
		}

		reportHtml += `</div>`;
        document.getElementById('ai-report-content').innerHTML = reportHtml;

        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('ai-modal').style.display = 'block';

    } catch (error) {
        console.error("ë¶„ì„ ì˜¤ë¥˜:", error);
        alert("ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        aiBtn.innerText = "ğŸ¤– 1:1 ì •ë°€ ë¶„ì„ ì‹¤í–‰";
        aiBtn.disabled = false;
    }
}

function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
    document.getElementById('ai-modal').style.display = 'none';
}
</script>
</body>
</html>