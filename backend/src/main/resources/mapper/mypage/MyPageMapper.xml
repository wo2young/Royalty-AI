<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.royalty.backend.mypage.mapper.MyPageMapper">

    <select id="selectMyBrands" resultType="com.royalty.backend.mypage.dto.BrandDTO">
        SELECT 
            b.brand_id, 
            b.brand_name, 
            b.category,
            b.is_notification_enabled,
            b.created_at,
            l.image_path AS logoPath
        FROM brand b
        LEFT JOIN brand_logo l ON b.brand_id = l.brand_id
        WHERE b.user_id = #{userId}
        ORDER BY b.created_at DESC
    </select>

    <select id="selectBrandDetail" resultType="com.royalty.backend.mypage.dto.BrandDetailDTO">
        SELECT 
            b.brand_id, 
            b.brand_name, 
            b.category,
            b.description,
            b.is_notification_enabled,
            l.image_path AS currentLogoPath
        FROM brand b
        LEFT JOIN brand_logo l ON b.brand_id = l.brand_id
        WHERE b.brand_id = #{brandId} AND b.user_id = #{userId}
    </select>

    <insert id="insertBrand" useGeneratedKeys="true" keyProperty="brandId">
	    INSERT INTO brand (
	        user_id, 
	        brand_name, 
	        category, 
	        description, 
	        is_notification_enabled
	    ) VALUES (
	        #{userId}, 
	        #{brandName}, 
	        #{category}, 
	        #{description},
	        false
        )
	</insert>

    <insert id="insertBrandLogo">
        INSERT INTO brand_logo (brand_id, image_path)
        VALUES (#{brandId}, #{imagePath})
    </insert>

	<update id="updateBrand" parameterType="com.royalty.backend.mypage.dto.BrandDTO">
	    UPDATE brand
	    <set>
	        <if test="brandName != null">brand_name = #{brandName},</if>
	        <if test="category != null">category = #{category},</if>
	        <if test="description != null">description = #{description}</if>
	    </set>
	    WHERE brand_id = #{brandId} AND user_id = #{userId}
	</update>
	
	<update id="updateBrandLogo">
	    UPDATE brand_logo
	    SET 
	        image_path = #{imagePath}
	    WHERE brand_id = #{brandId}
	</update>

    <update id="updateNotificationStatus">
        UPDATE brand
        SET is_notification_enabled = #{isEnabled}
        WHERE brand_id = #{brandId} AND user_id = #{userId}
    </update>

    <delete id="deleteBrand">
        DELETE FROM brand 
        WHERE brand_id = #{brandId} AND user_id = #{userId}
    </delete>

	<select id="selectBrandHistory" resultType="com.royalty.backend.mypage.dto.BrandHistoryDTO">
	    SELECT 
	        version, 
	        image_path AS imagePath, 
	        image_similarity AS imageSimilarity, 
	        text_similarity AS textSimilarity, 
	        created_at AS createdAt,
	        ai_summary AS aiSummary,      analysis_detail AS analysisDetail, patent_id AS patentId         FROM brand_logo_history
	    WHERE brand_id = #{brandId}
	    ORDER BY created_at DESC
	</select>

<!--    <select id="selectBrandReports" resultType="com.royalty.backend.mypage.dto.ReportDTO">-->
<!--        SELECT report_id, brand_id, file_path, created_at-->
<!--        FROM report-->
<!--        WHERE brand_id = #{brandId}-->
<!--        ORDER BY created_at DESC-->
<!--    </select>-->

    <select id="selectBookmarks" resultType="com.royalty.backend.mypage.dto.BookmarkDTO">
        SELECT 
            b.bookmark_id, p.patent_id, p.trademark_name, p.image_url, 
            p.application_number, p.category, p.applicant, p.status , b.created_at
        FROM bookmark b
        JOIN patent p ON b.patent_id = p.patent_id
        WHERE b.user_id = #{userId}
        ORDER BY b.created_at DESC
    </select>

</mapper>