<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.royalty.backend.trademark.mapper.TrademarkMapper">

    <select id="selectTrademarkList" resultType="com.royalty.backend.trademark.dto.TrademarkDto">
        SELECT 
            patent_id          AS patentId,
            application_number AS applicationNumber,
            trademark_name     AS trademarkName,
            image_url          AS imageUrl,
            applicant          AS applicant,
            category           AS category,
            status             AS status,
            application_date   AS applicationDate,
            registered_date    AS registeredDate
        FROM patent
        WHERE 1=1
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND trademark_name LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY application_date DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    
    <select id="countTrademarkList" resultType="int">
        SELECT count(*) FROM patent WHERE 1=1
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND trademark_name LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>

    <select id="selectExpiringTrademarks" resultType="com.royalty.backend.trademark.dto.TrademarkDto">
        SELECT 
            patent_id          AS patentId,
            application_number AS applicationNumber,
            trademark_name     AS trademarkName,
            image_url          AS imageUrl,
            applicant          AS applicant,
            category           AS category,
            status             AS status,
            application_date   AS applicationDate,
            registered_date    AS registeredDate,
            
            -- [만료일 계산: 10년, 20년, 30년... 주기 자동 계산]
            -- 공식: 등록일 + ((현재까지 지난 연수 / 10) + 1) * 10년
            (registered_date + (
                (EXTRACT(YEAR FROM AGE(CURRENT_DATE, registered_date))::int / 10 + 1) * INTERVAL '10 years'
            ))::date AS expirationDate,
            
            -- [D-Day 계산] 계산된 만료일 - 오늘
            EXTRACT(DAY FROM (
                (registered_date + (
                    (EXTRACT(YEAR FROM AGE(CURRENT_DATE, registered_date))::int / 10 + 1) * INTERVAL '10 years'
                )) - CURRENT_DATE
            )) AS daysLeft
            
        FROM patent
        WHERE status = '등록' 
          AND registered_date IS NOT NULL
          -- 만료일이 과거가 아닌 것만 (오늘 이후 만료)
          AND (registered_date + (
                (EXTRACT(YEAR FROM AGE(CURRENT_DATE, registered_date))::int / 10 + 1) * INTERVAL '10 years'
            )) > CURRENT_DATE
        ORDER BY expirationDate ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countExpiringTrademarks" resultType="int">
        SELECT count(*) FROM patent
        WHERE status = '등록' 
          AND registered_date IS NOT NULL
          AND (registered_date + INTERVAL '10 years') > CURRENT_DATE
    </select>

    <select id="selectTrademarkById" resultType="com.royalty.backend.trademark.dto.TrademarkDto">
        SELECT 
            patent_id          AS patentId,
            application_number AS applicationNumber,
            trademark_name     AS trademarkName,
            image_url          AS imageUrl,
            applicant          AS applicant,
            category           AS category,
            status             AS status,
            application_date   AS applicationDate,
            registered_date    AS registeredDate
        FROM patent
        WHERE patent_id = #{id}
    </select>

    <select id="existsBookmark" resultType="int">
        SELECT count(*) 
        FROM bookmark 
        WHERE user_id = #{userId} AND patent_id = #{patentId}
    </select>

    <insert id="insertBookmark">
        INSERT INTO bookmark (user_id, patent_id, created_at)
        VALUES (#{userId}, #{patentId}, NOW())
        ON CONFLICT (user_id, patent_id) DO NOTHING
    </insert>

    <delete id="deleteBookmark">
        DELETE FROM bookmark 
        WHERE user_id = #{userId} AND patent_id = #{patentId}
    </delete>

</mapper>